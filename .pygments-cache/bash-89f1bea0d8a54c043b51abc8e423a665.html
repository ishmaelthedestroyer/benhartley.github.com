<div class="highlight"><pre><span class="c"># you can define multiple backends using the following syntax:</span>

backend node <span class="o">{</span>
	.host <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>;
	.port <span class="o">=</span> <span class="s2">&quot;3000&quot;</span>;
<span class="o">}</span>

backend nginx <span class="o">{</span>
	.host <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>;
	.port <span class="o">=</span> <span class="s2">&quot;81&quot;</span>;
<span class="o">}</span>


<span class="c"># incoming traffic gets dealt with inside the following block</span>

sub vcl_recv <span class="o">{</span>

	<span class="c"># choose backend based on request</span>
	<span class="k">if</span> <span class="o">(</span>req.url ~ <span class="s2">&quot;\.(js|css|jpg|png)$&quot;</span><span class="o">)</span> <span class="o">{</span>
		<span class="nb">set </span>req.backend <span class="o">=</span> nginx;
	<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
		<span class="nb">set </span>req.backend <span class="o">=</span> node;
	<span class="o">}</span>

	<span class="c"># pipe websocket connections directly to node app</span>
		<span class="k">if</span> <span class="o">(</span>req.http.upgrade ~ <span class="s2">&quot;(?i)websocket&quot;</span> <span class="o">||</span> req.url ~ <span class="s2">&quot;^/socket.io/&quot;</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="o">(</span>pipe<span class="o">)</span>;
	<span class="o">}</span>

<span class="o">}</span>


<span class="c"># outgoing traffic gets dealt with below</span>

sub vcl_pipe <span class="o">{</span>

	<span class="c"># copy the upgrade header so websocket connections get upgraded to 1.1</span>
	<span class="k">if</span> <span class="o">(</span>req.http.upgrade<span class="o">)</span> <span class="o">{</span>
		<span class="nb">set </span>bereq.http.upgrade <span class="o">=</span> req.http.upgrade;
	<span class="o">}</span>

	<span class="k">return</span> <span class="o">(</span>pipe<span class="o">)</span>;

<span class="o">}</span>
</pre>
</div>
